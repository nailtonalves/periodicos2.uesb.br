# Dockerfile.ojs
FROM pkpofficial/ojs:3_3_0-17

# # Instalar extensões PHP necessárias
RUN apk add --no-cache \
#     php81-bcmath \
#     php81-bz2 \
#     php81-calendar \
#     php81-ctype \
#     php81-curl \
#     php81-dom \
#     php81-exif \
#     php81-fileinfo \
#     php81-ftp \
    php81-gd \
#     php81-gettext \
#     php81-intl \
#     gnu-libiconv \
#     php81-json \
#     php81-mbstring \
    php81-pgsql \
    php81-pdo_pgsql \
#     php81-opcache \
#     php81-openssl \
#     php81-phar \
#     php81-session \
#     php81-simplexml \
#     php81-xml \
#     php81-xmlreader \
#     php81-xmlwriter \
    php81-zip \
    php81-zlib

# COPY ./volumes/private /var/www/files
# COPY ./volumes/public /var/www/html/public
#      # WARNING: You can only enable file-volumes if file exists in the container.

# Remove config padrão e copia o customizado
RUN rm /var/www/html/config.inc.php && \
    echo "Config será copiado na próxima camada"
    
COPY ./volumes/config/config.inc.php /var/www/html/config.inc.php

# Copiar .htaccess para proteção adicional
COPY ./volumes/config/.htaccess /var/www/html/.htaccess

# Aplicar permissões de segurança ao config.inc.php
RUN chmod 640 /var/www/html/config.inc.php && \
    chown apache:apache /var/www/html/config.inc.php && \
    # Proteger outros arquivos .inc.php
    find /var/www/html -name "*.inc.php" -type f -exec chmod 640 {} \; && \
    find /var/www/html -name "*.inc.php" -type f -exec chown apache:apache {} \; && \
    # Remover arquivos de backup se existirem
    find /var/www/html -name "*.bak" -type f -delete && \
    find /var/www/html -name "*.backup" -type f -delete && \
    # Proteger .htaccess
    chmod 644 /var/www/html/.htaccess && \
    chown apache:apache /var/www/html/.htaccess

# Copiar configuração Apache com proteções de segurança
COPY ./volumes/config/ojs.conf /etc/apache2/conf.d/ojs-security.conf

# Correções de códigos - todos os arquivos em uma única camada
COPY ./volumes/correcoes/display.tpl /var/www/html/plugins/generic/pdfJsViewer/templates/display.tpl
COPY ./volumes/correcoes/viewer.js ./volumes/correcoes/viewer.js.map /var/www/html/plugins/generic/pdfJsViewer/pdf.js/web/
COPY ./volumes/correcoes/PKPRequest.inc.php /var/www/html/lib/pkp/classes/core/
COPY ./volumes/correcoes/PKPSitemapHandler.inc.php /var/www/html/lib/pkp/pages/sitemap/
COPY ./volumes/correcoes/article_details.tpl /var/www/html/templates/frontend/objects/article_details.tpl
COPY ./volumes/correcoes/headerHead.tpl /var/www/html/lib/pkp/templates/frontend/components/headerHead.tpl

# Script de atualização do OJS - desativado por enquanto
# COPY ./volumes/config/update-ojs.sh /tmp/update.sh
# Torne o script executável
# RUN chmod +x /tmp/update.sh
# Defina ENTRYPOINT e CMD
# ENTRYPOINT ["/tmp/update.sh"]
# RUN sh /usr/local/bin/ojs-upgrade

# Portas expostas
EXPOSE 80
EXPOSE 443

# Comando de inicialização (use o mesmo da imagem original)
CMD ["ojs-start"]