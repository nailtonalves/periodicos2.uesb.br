# Carregar módulos necessários
LoadModule remoteip_module modules/mod_remoteip.so
LoadModule headers_module modules/mod_headers.so

<VirtualHost *:80>
        # Nome interno do container
        ServerName ojs-periodicos
        # Domínio público
        ServerAlias periodicos2.uesb.br
        DocumentRoot /var/www/html

        # Configuração para tráfego via proxy reverso
        RemoteIPHeader X-Forwarded-For
        # Sub-rede do Docker/proxy (ajuste conforme necessário)
        RemoteIPInternalProxy 10.0.0.0/8

        # Forçar reconhecimento de HTTPS (já que o SSL é terminado no proxy)
        SetEnvIf X-Forwarded-Proto "https" HTTPS=on
        SetEnvIf X-Forwarded-Proto "https" REQUEST_SCHEME=https
        RequestHeader set X-Forwarded-Proto "https" env=HTTPS

        RewriteEngine on
        AcceptPathInfo On
        
        # Bloquear acesso a arquivos sensíveis
        <FilesMatch "^\.?(ht|git|env|config\.inc\.php|\.bak|\.backup)">
                Require all denied
        </FilesMatch>
        
        <Directory /var/www/html>
                Options -Indexes +FollowSymLinks
                AllowOverride all
                Allow from all

                # This removes index.php from the url
                RewriteCond %{REQUEST_FILENAME} !-d
                RewriteCond %{REQUEST_FILENAME} !-f
                RewriteRule ^(.*)$ index.php/$1 [QSA,L]
        </Directory>

        # ErrorLog  /var/log/apache2/error.log
        # CustomLog  /var/log/apache2/access.log combined

        # See https://github.com/pkp/docker-ojs/issues/29
        ErrorLog  /dev/stderr
        CustomLog /dev/stdout combined

</VirtualHost>
<VirtualHost *:443>
        ServerName localhost
        DocumentRoot /var/www/html

        SSLEngine on
        SSLCertificateFile /etc/ssl/apache2/server.pem
        SSLCertificateKeyFile /etc/ssl/apache2/server.key

        PassEnv HTTPS
        RewriteEngine on
        AcceptPathInfo On
        
        # Bloquear acesso a arquivos sensíveis
        <FilesMatch "^\.?(ht|git|env|config\.inc\.php|\.bak|\.backup)">
                Require all denied
        </FilesMatch>
        
        <Directory /var/www/html>
                Options -Indexes +FollowSymLinks
                AllowOverride all
                Allow from all

                # This removes index.php from the url
                RewriteCond %{REQUEST_FILENAME} !-d
                RewriteCond %{REQUEST_FILENAME} !-f
                RewriteRule ^(.*)$ index.php/$1 [QSA,L]
        </Directory>

        # ErrorLog  /var/log/apache2/error.log

        # CustomLog  /var/log/apache2/access.log combined

        # See https://github.com/pkp/docker-ojs/issues/29
        ErrorLog  /dev/stderr
        CustomLog /dev/stdout combined

</VirtualHost>
